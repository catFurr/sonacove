name: Test Preview Deployment

on:
  workflow_run:
    workflows: ["Deploy"]
    types:
      - completed

permissions:
  contents: read
  pull-requests: write
  actions: read

jobs:
  test-preview:
    name: Test Preview Deployment
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.event == 'pull_request' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Download preview URL
        uses: actions/download-artifact@v4
        with:
          name: preview-url
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: Run all tests
        run: |
          PREVIEW_URL=$(cat preview-url.txt)
          echo "ğŸ§ª Running all tests against: $PREVIEW_URL"
          TEST_API_ENDPOINT="$PREVIEW_URL" bun test
        env:
          NODE_ENV: test

      - name: Comment test results on PR
        if: always()
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: preview-testing
          message: |
            ## ğŸ§ª Preview Testing Results

            **Status:** ${{ job.status == 'success' && 'âœ… All tests passed' || 'âŒ Some tests failed' }}
            **Preview URL:** $(cat preview-url.txt 2>/dev/null || echo "Unknown")
            **Test Suite:** All Tests
            **Commit:** ${{ github.event.workflow_run.head_sha }}

            ${{ job.status == 'success' && 'ğŸ‰ All tests passed successfully against the preview deployment!' || 'âš ï¸ Some tests failed. Please check the workflow logs for details.' }}

            ---
            *This comment is automatically updated when tests run against preview deployments.*
